{% extends "./layouts/_RESULTS.html" %}
{% from "./macros/clear-filter-link.njk" import clearFilterLink %}

<!--Find the person in the data-->

{% set withoutDescription = "true" %}
{% set pageHeading = "Search results" %}
{% set pageDescription = "Use the filters to explore these nearby courses." %}

{% block content %}

<div class="govuk-grid-row">

  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">Your search results</h1>
    
    <p class="govuk-body-l">
      Showing {{ totalResults }} courses
      {% if data['location'] %} near <strong>{{ data['location'] }}</strong>{% endif %}
    
      {% if data['interest-1'] %} for <strong>{{ data['interest-1'] }}</strong>{% endif %}
      {% if data['interest-2'] %}, <strong>{{ data['interest-2'] }}</strong>{% endif %}
      {% if data['interest-3'] %}, <strong>{{ data['interest-3'] }}</strong>{% endif %}

      <!--
    
      {% if data['qualification-level'] %}
        {% set levelLabels = {
          "level-1-2": "Level 1 or 2",
          "level-3": "Level 3",
          "level-4-7": "Level 4 to 7"
        } %}
    
        {% set sel = data['qualification-level'] %}
        {% if sel is string %}
          {% set sel = [sel] %}
        {% endif %}
    
        at
        {% for code in sel %}
          {% set label = levelLabels[code] or code %}
    
          {% if loop.first %}
            <strong>{{ label }}</strong>
          {% elseif loop.last %}
            and <strong>{{ label }}</strong>
          {% else %}
            , <strong>{{ label }}</strong>
          {% endif %}
        {% endfor %}
      {% endif %}
      -->
    </p>
    
    
    
    
    
    

      <p><a href="clear-session-and-go">Search again</a> </p>
  
      <hr class="govuk-section-break govuk-section-break--xl govuk-section-break--visible">

    </div>


  
  <div class="govuk-grid-column-one-third">

    <button class="govuk-button govuk-button--secondary govuk-!-margin-bottom-3 govuk-!-display-none-print" 
    id="toggle-filters" type="button">
Show filters
</button>

<div id="filter-panel" class="filter-container" hidden>

    <form method="get" action="load-courses">

      <div class="filter-container">

        <div class="filter-search-terms">
  
        <div class="filter-heading">

        <h2 class="govuk-heading-m">Filter</h2>

        </div>

        </div>

        <div class="filter-list">

      <fieldset class="govuk-fieldset">

        <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Course type</legend>
    
        <div class="govuk-checkboxes govuk-checkboxes--small">
          {% for qual in ["A Level", "Apprenticeship", "BTEC", "Diploma", "Degree", "T Level"] %}
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input"
                     id="filter-{{ qual | replace(' ', '-') }}"
                     name="filter"
                     type="checkbox"
                     value="{{ qual }}"
                     {% if qual in selectedQualifications %}checked{% endif %}>
              <label class="govuk-label govuk-checkboxes__label" for="filter-{{ qual | replace(' ', '-') }}">{{ qual }}</label>
            </div>
          {% endfor %}
        </div>
      </fieldset>
      {% if selectedQualifications.length > 0 %}
      {{ clearFilterLink("filter", query) }}
    {% endif %}
    
<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

      {{ govukSelect({
        id: "travel-location",
        name: "travel-location",
        label: {
          text: "Travel distance"
        },
        items: [
          { value: "", text: "Select a distance" },
          { value: "2 miles", text: "Up to 2 miles", selected: travelDistance == "2 miles" },
          { value: "5 miles", text: "Up to 5 miles", selected: travelDistance == "5 miles" },
          { value: "10 miles", text: "Up to 10 miles", selected: travelDistance == "10 miles" },
          { value: "15 miles", text: "Up to 15 miles", selected: travelDistance == "15 miles" },
          { value: "30 miles", text: "Up to 30 miles", selected: travelDistance == "30 miles" }
        ]
      }) }}

      {% if selectedLocation %}
  {{ clearFilterLink("option-select-filter-location", query) }}
{% endif %}

<!--
      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

      <div class="govuk-form-group">
        <label class="govuk-label" for="subject-filter">
          Keyword
        </label>
        <input class="govuk-input"
               type="text"
               id="subject-filter"
               name="subject-filter">
      </div>
-->
      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

      <fieldset class="govuk-fieldset">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Qualification level</legend>
      
        <div class="govuk-checkboxes govuk-checkboxes--small">
          {% set allLevels = [
            { value: "entry", label: "Entry level (like entry level functional skills)" },
            { value: "level-1", label: "Level 1 (like first certificate)" },
            { value: "level-2", label: "Level 2 (like GCSEs)" },
            { value: "level-3", label: "Level 3 (like A levels)" },
            { value: "level-4", label: "Level 4 (like high national certificate)" },
            { value: "level-5", label: "Level 5 (like diplomas)" },
            { value: "level-6", label: "Level 6 (like degree)" },
            { value: "level-7", label: "Level 7 (like masters degree)" }
          ] %}
      
          {% for level in allLevels %}
            <div class="govuk-checkboxes__item">
              <input class="govuk-checkboxes__input"
                     id="qualification-level-{{ level.value }}"
                     name="qualification-level"
                     type="checkbox"
                     value="{{ level.value }}"
                     {% if level.value in selectedLevels %}checked{% endif %}>
              <label class="govuk-label govuk-checkboxes__label"
                     for="qualification-level-{{ level.value }}">
                {{ level.label }}
              </label>
            </div>
          {% endfor %}
        </div>
      </fieldset>
      {% if selectedLevels.length > 0 %}
  {{ clearFilterLink("qualification-level", query) }}
{% endif %}

<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
<fieldset class="govuk-fieldset">
  <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Learning method</legend>

  <div class="govuk-checkboxes govuk-checkboxes--small">
    {% set methods = ["Online", "Classroom based", "Work based", "Hybrid"] %}
    {% for method in methods %}
      {% set valueLower = method | lower %}
      <div class="govuk-checkboxes__item">
        <input class="govuk-checkboxes__input"
               id="learning-method-{{ loop.index }}"
               name="learning-method"
               type="checkbox"
               value="{{ method }}"
               {% if selectedLearningMethods and (valueLower in selectedLearningMethods) %}checked{% endif %}>
        <label class="govuk-label govuk-checkboxes__label" for="learning-method-{{ loop.index }}">
          {{ method }}
        </label>
      </div>
    {% endfor %}
  </div>
</fieldset>
{% if selectedLearningMethods and selectedLearningMethods.length > 0 %}
  {{ clearFilterLink("learning-method", query) }}
{% endif %}


<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
<fieldset class="govuk-fieldset">
  <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Course hours</legend>

  <div class="govuk-checkboxes govuk-checkboxes--small">
    {% for hours in ["Full time", "Part time", "Flexible"] %}
      {% set valueLower = hours | lower %}
      <div class="govuk-checkboxes__item">
        <input class="govuk-checkboxes__input"
               id="course-hours-{{ loop.index }}"
               name="course-hours"
               type="checkbox"
               value="{{ hours }}"
               {% if selectedCourseHours and (valueLower in selectedCourseHours) %}checked{% endif %}>
        <label class="govuk-label govuk-checkboxes__label" for="course-hours-{{ loop.index }}">
          {{ hours }}
        </label>
      </div>
    {% endfor %}
  </div>
</fieldset>
{% if selectedCourseHours and selectedCourseHours.length > 0 %}
  {{ clearFilterLink("course-hours", query) }}
{% endif %}


<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
<fieldset class="govuk-fieldset">
  <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Course study time</legend>

  <div class="govuk-checkboxes govuk-checkboxes--small">
    {% for times in ["Daytime", "Evening", "Weekend"] %}
      {% set valueLower = times | lower %}
      <div class="govuk-checkboxes__item">
        <input class="govuk-checkboxes__input"
               id="course-times-{{ loop.index }}"
               name="course-times"
               type="checkbox"
               value="{{ times }}"
               {% if selectedCourseTimes and (valueLower in selectedCourseTimes) %}checked{% endif %}>
        <label class="govuk-label govuk-checkboxes__label" for="course-times-{{ loop.index }}">
          {{ times }}
        </label>
      </div>
    {% endfor %}
  </div>
</fieldset>
{% if selectedCourseTimes and selectedCourseTimes.length > 0 %}
  {{ clearFilterLink("course-times", query) }}
{% endif %}


      
    <br>
      <button class="govuk-button" type="submit">Apply filters</button>

      <p class="govuk-body">
        <a href="/08/load-courses" class="govuk-link" id="clear-all-link">Clear all filters</a>
      </p>
      
    </form>
    
  </div>
</div>
</div>
</div>


  <div class="govuk-grid-column-two-thirds">

<h2 class="govuk-heading-m">Available courses</h2>


<!-- <p class="govuk-body govuk-!-margin-bottom-6">
  <span class="govuk-!-font-weight-bold">Sort courses by:</span> 
<span class="govuk-!-margin-left-1 govuk-!-margin-right-1">
  
<span class="">Distance</span>
</span>    
 | 
<span class="govuk-!-margin-left-2 govuk-!-margin-right-1">
    <a href="/records?sortOrder=lastName" class="govuk-link govuk-link--no-visited-state">Relevance</a>
</span>
</p>
-->

{# Build a base QS that preserves filters + travel distance + location/subject #}
{% set filterQuery = "" %}
{% for qual in selectedQualifications %}
  {% if qual != "_unchecked" and qual %}
    {% set filterQuery = filterQuery + "&filter=" + qual %}
  {% endif %}
{% endfor %}
{% set filterQuery = filterQuery
  + "&option-select-filter-location=" + (selectedLocation or '')
  + "&subject-filter=" + (selectedSubject or '')
  + "&travel-location=" + (travelDistance or '')
%}

{% set distanceUrl  = "?page=1" + filterQuery + "&sort=distance" %}
{% set relevanceUrl = "?page=1" + filterQuery + "&sort=relevance" %}

<p class="govuk-body govuk-!-margin-bottom-6">
  <span class="govuk-!-font-weight-bold">Sort courses by:</span>
  <span class="govuk-!-margin-left-2">
    {% if sort == "distance" %}
      <span aria-current="true">Distance</span>
      | <a class="govuk-link govuk-link--no-visited-state" href="{{ relevanceUrl }}">Relevance</a>
    {% elseif sort == "relevance" %}
      <a class="govuk-link govuk-link--no-visited-state" href="{{ distanceUrl }}">Distance</a>
      | <span aria-current="true">Relevance</span>
    {% else %}
      <a class="govuk-link govuk-link--no-visited-state" href="{{ distanceUrl }}">Distance</a>
      | <a class="govuk-link govuk-link--no-visited-state" href="{{ relevanceUrl }}">Relevance</a>
    {% endif %}
  </span>
</p>



{% for course in courses %}
<div class="govuk-summary-card">
  <div class="govuk-summary-card__title-wrapper">
    <h2 class="govuk-summary-card__title">
      {{ course.name }}
    </h2>
    <ul class="govuk-summary-card__actions">
      <li class="govuk-summary-card__action">
        <a class="govuk-link" href="/08/course/{{ course.slug }}">
          View more details<span class="govuk-visually-hidden"> about {{ course.name }}</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="govuk-summary-card__content">
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          Provider
        </dt>
        <dd class="govuk-summary-list__value">
          {{ course.provider }}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          Location
        </dt>
        <dd class="govuk-summary-list__value">
          {{ course.location }}{% if course.distance %}, {{ course.distance }}{% endif %}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          Course type
        </dt>
        <dd class="govuk-summary-list__value">
          {{ course.type }}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          Requirements
        </dt>
        <dd class="govuk-summary-list__value">
          {{ course.requirements }}
        </dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Overview</dt>
        <dd class="govuk-summary-list__value">
      
          {{ course.shortOverview }}
      
          {% if course.remainingOverview %}
            <details class="govuk-details govuk-!-margin-top-2" data-module="govuk-details">
              <summary class="govuk-details__summary">
                <span class="govuk-details__summary-text">
                  Read more of the course overview
                </span>
              </summary>
              <div class="govuk-details__text">
                {{ course.remainingOverview }}
              </div>
            </details>
          {% endif %}
      
        </dd>
      </div>
    </dl>
  </div>
</div>
{% endfor %}

{# Build query string to preserve selected filters #}
{% set filterQuery = "" %}
{% for qual in selectedQualifications %}
  {% if qual != "_unchecked" %}
    {% set filterQuery = filterQuery + "&filter=" + qual %}
  {% endif %}
{% endfor %}

{# Always preserve location/subject #}
{% set filterQuery = filterQuery
  + "&option-select-filter-location=" + (selectedLocation or '')
  + "&subject-filter=" + (selectedSubject or '')
%}

{# Preserve travel distance and sort choice #}
{% set filterQuery = filterQuery
  + "&travel-location=" + (travelDistance or '')
  + "&sort=" + (query.sort or '')
%}

{# Preserve new checkbox filters #}
{% for m in selectedLearningMethods or [] %}
  {% set filterQuery = filterQuery + "&learning-method=" + m %}
{% endfor %}
{% for h in selectedCourseHours or [] %}
  {% set filterQuery = filterQuery + "&course-hours=" + h %}
{% endfor %}
{% for t in selectedCourseTimes or [] %}
  {% set filterQuery = filterQuery + "&course-times=" + t %}
{% endfor %}



<nav class="govuk-pagination" aria-label="Pagination">

  {% if currentPage > 1 %}
    <div class="govuk-pagination__prev">
      <a class="govuk-link govuk-pagination__link" href="?page={{ currentPage - 1 }}{{ filterQuery }}" rel="prev">
        <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
          <path d="m6.5938-0.0088125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
        </svg>
        <span class="govuk-pagination__link-title">
          Previous<span class="govuk-visually-hidden"> page</span>
        </span>
      </a>
    </div>
  {% endif %}

  <ul class="govuk-pagination__list">
    {# Calculate page range for 3 numbers max #}
    {% set startPage = currentPage - 1 %}
    {% set endPage = currentPage + 1 %}

    {% for qual in selectedQualifications %}
  {% if qual != "_unchecked" and qual != "" %}
    {% set filterQuery = filterQuery + "&filter=" + qual %}
  {% endif %}
{% endfor %}

    {% if startPage < 1 %}
      {% set startPage = 1 %}
      {% set endPage = 3 %}
    {% endif %}

    {% if endPage > totalPages %}
      {% set endPage = totalPages %}
    {% endif %}

    {% if totalPages <= 3 %}
      {% set startPage = 1 %}
      {% set endPage = totalPages %}
    {% elif endPage - startPage < 2 %}
      {% set startPage = endPage - 2 %}
      {% if startPage < 1 %}
        {% set startPage = 1 %}
      {% endif %}
    {% endif %}

    {# Render page number links #}
    {% for pageNumber in range(startPage, endPage + 1) %}
      <li class="govuk-pagination__item {% if pageNumber == currentPage %}govuk-pagination__item--current{% endif %}">
        <a class="govuk-link govuk-pagination__link"
           href="?page={{ pageNumber }}{{ filterQuery }}"
           aria-label="Page {{ pageNumber }}"
           {% if pageNumber == currentPage %} aria-current="page"{% endif %}>
          {{ pageNumber }}
        </a>
      </li>
    {% endfor %}
  </ul>

  {% if currentPage < totalPages %}
    <div class="govuk-pagination__next">
      <a class="govuk-link govuk-pagination__link" href="?page={{ currentPage + 1 }}{{ filterQuery }}" rel="next">
        <span class="govuk-pagination__link-title">
          Next<span class="govuk-visually-hidden"> page</span>
        </span>
        <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
          <path d="m8.108-0.0088125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
        </svg>
      </a>
    </div>
  {% endif %}

</nav>



{% endblock %}

{% block footer %}

{% from "govuk/components/footer/macro.njk" import govukFooter %}

{{ govukFooter({
  navigation: [
    {
      title: "Website information",
      width: "two-thirds",
      columns: 2,
      items: [
        {
          href: "#",
          text: "About us"
        },
        {
          href: "#",
          text: "Help"
        },
        {
          href: "#",
          text: "Privacy and cookies"
        },
        {
          href: "#",
          text: "Accessibility statement"
        },
        {
          href: "#",
          text: "Terms and conditions"
        }
      ]
    },
    {
      title: "Sites for other UK countries",
      width: "one-third",
      items: [
        {
          href: "#",
          text: "Scotland"
        },
        {
          href: "#",
          text: "Wales"
        },
        {
          href: "#",
          text: "Northern Ireland"
        }
      ]
    },
    {
      title: "Additional views",
      width: "full",
      items: [
        {
          href: "search-results-no-results",
          text: "No results"
        },
        {
          href: "courses-quirky",
          text: "Quirky results - you might be interested in..."
        },
        {
          href: "courses-quirky-2",
          text: "Quirky results - History with English result"
        }
      ]
    }
  ]
}) }}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toggleButton = document.getElementById('toggle-filters');
    const filterPanel = document.getElementById('filter-panel');

    toggleButton.addEventListener('click', function () {
      const isActive = filterPanel.classList.contains('active');

      if (isActive) {
        filterPanel.classList.remove('active');
        toggleButton.textContent = 'Show filters';
      } else {
        filterPanel.classList.add('active');
        toggleButton.textContent = 'Hide filters';
      }
    });
  });

  
</script>

{% endblock %}

